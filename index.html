<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diminished Value Calculator</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 40px 20px;
            background: #f8fafc;
            color: #334155;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='m36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            opacity: 0.1;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.25rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .header p {
            margin: 0;
            font-size: 1.125rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .form-content {
            padding: 40px 30px;
        }

        .trust-indicators {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 32px;
            margin: 0 0 40px 0;
            padding: 24px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .trust-item {
            text-align: center;
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .section-number {
            background: #1e40af;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            margin-right: 12px;
        }

        .section-title {
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input:hover, select:hover {
            border-color: #9ca3af;
        }

        .damage-tiers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .tier {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: white;
        }

        .tier:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .tier.selected {
            border-color: #1e40af;
            background: #eff6ff;
            box-shadow: 0 4px 6px -1px rgba(30, 64, 175, 0.1);
        }

        .tier input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            cursor: pointer;
        }

        .tier-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .tier-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .tier-1 .tier-icon { background: #10b981; }
        .tier-2 .tier-icon { background: #f59e0b; }
        .tier-3 .tier-icon { background: #ef4444; }
        .tier-4 .tier-icon { background: #7c2d12; }

        .tier-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .tier-description {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .calculate-section {
            text-align: center;
            margin: 40px 0;
            padding: 32px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .calculate-btn {
            background: #1e40af;
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 240px;
            justify-content: center;
        }

        .calculate-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .results {
            margin-top: 32px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            overflow: hidden;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .results-header {
            background: #059669;
            color: white;
            padding: 20px 24px;
            text-align: center;
        }

        .results-header h3 {
            margin: 0 0 8px 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .results-subtext {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .value-display {
            padding: 32px 24px;
            text-align: center;
            background: #f0fdf4;
        }

        .value-range {
            font-size: 2.5rem;
            font-weight: 700;
            color: #059669;
            margin: 0 0 16px 0;
            letter-spacing: -0.025em;
        }

        .results-details {
            padding: 24px;
            background: white;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .result-value {
            font-weight: 600;
            color: #1f2937;
        }

        .methodology {
            margin-top: 16px;
            padding: 16px;
            background: #fffbeb;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #92400e;
        }

        .disclaimer {
            margin-top: 32px;
            padding: 20px 24px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #475569;
            line-height: 1.6;
        }

        .disclaimer strong {
            color: #334155;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .header, .form-content {
                padding: 24px 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .damage-tiers {
                grid-template-columns: 1fr;
            }
            
            .trust-indicators {
                flex-direction: column;
                gap: 16px;
            }
            
            .value-range {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo-container" style="margin-bottom: 20px;">
                    <!-- 
                    TO ADD YOUR MYFAIRCLAIM LOGO:
                    
                    OPTION 1 - Upload to your website:
                    1. Upload your MyFairClaim logo to your website (e.g., /images/myfairclaim-logo.png)
                    2. Replace "YOUR-LOGO-PATH-HERE" below with the actual path
                    
                    OPTION 2 - Base64 embedding:
                    1. Go to https://www.base64-image.de/
                    2. Upload your logo image
                    3. Copy the result (starts with "data:image/png;base64,...")
                    4. Replace "YOUR-LOGO-PATH-HERE" with the copied data URL
                    -->
                    <img src="YOUR-LOGO-PATH-HERE" 
                         alt="MyFairClaim - Professional Diminished Value Assessments" 
                         style="max-height: 80px; width: auto; margin-bottom: 10px;"
                         onerror="this.style.display='none';">
                </div>
                <h1>Professional Diminished Value Assessment</h1>
                <p>Industry-standard evaluation for insurance claims and legal proceedings</p>
            </div>
        </div>

        <div class="form-content">
            <div class="trust-indicators">
                <div class="trust-item">âœ“ Industry Standards</div>
                <div class="trust-item">âœ“ Professional Grade</div>
                <div class="trust-item">âœ“ Certified Methodology</div>
                <div class="trust-item">âœ“ Insurance Accepted</div>
            </div>

            <form id="calculatorForm">
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-number">1</div>
                        <h3 class="section-title">Contact Information</h3>
                    </div>
                    
                    <p style="margin-bottom: 20px; color: #6b7280; font-size: 0.875rem;">
                        Please provide your contact information to receive your professional assessment:
                    </p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">Full Name <span style="color: #dc2626;">*</span></label>
                            <input type="text" id="customerName" placeholder="Your full name" required>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail">Email Address <span style="color: #dc2626;">*</span></label>
                            <input type="email" id="customerEmail" placeholder="your.email@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">Phone Number <span style="color: #dc2626;">*</span></label>
                            <input type="tel" id="customerPhone" placeholder="(555) 123-4567" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-number">2</div>
                        <h3 class="section-title">Vehicle Information</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="year">Model Year</label>
                            <input type="number" id="year" min="1990" max="2025" required>
                        </div>
                        <div class="form-group">
                            <label for="make">Make</label>
                            <input type="text" id="make" placeholder="e.g., Toyota, BMW, Ford" required>
                        </div>
                        <div class="form-group">
                            <label for="model">Model</label>
                            <input type="text" id="model" placeholder="e.g., Camry, X5, F-150" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mileage">Current Mileage</label>
                            <input type="number" id="mileage" placeholder="Odometer reading" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <div class="section-number">3</div>
                        <h3 class="section-title">Damage Assessment</h3>
                    </div>
                    
                    <p style="margin-bottom: 20px; color: #6b7280; font-size: 0.875rem;">
                        Select the tier that most accurately describes the extent of collision damage:
                    </p>
                    
                    <div class="damage-tiers">
                        <div class="tier tier-1" data-value="1">
                            <input type="radio" name="severity" value="1" required>
                            <div class="tier-header">
                                <div class="tier-icon"></div>
                                <div class="tier-name">Tier 1 - Minor Damage</div>
                            </div>
                            <div class="tier-description">
                                Cosmetic damage only. Small dents, surface scratches, minor paint work. No structural impact.
                            </div>
                        </div>
                        
                        <div class="tier tier-2" data-value="2">
                            <input type="radio" name="severity" value="2" required>
                            <div class="tier-header">
                                <div class="tier-icon"></div>
                                <div class="tier-name">Tier 2 - Moderate Damage</div>
                            </div>
                            <div class="tier-description">
                                Body panel replacement required. Multiple components affected. Moderate paint and body work.
                            </div>
                        </div>
                        
                        <div class="tier tier-3" data-value="3">
                            <input type="radio" name="severity" value="3" required>
                            <div class="tier-header">
                                <div class="tier-icon"></div>
                                <div class="tier-name">Tier 3 - Major Damage</div>
                            </div>
                            <div class="tier-description">
                                Frame or structural damage. Multiple panel replacement. Extensive paint and alignment work required.
                            </div>
                        </div>
                        
                        <div class="tier tier-4" data-value="4">
                            <input type="radio" name="severity" value="4" required>
                            <div class="tier-header">
                                <div class="tier-icon"></div>
                                <div class="tier-name">Tier 4 - Severe Damage</div>
                            </div>
                            <div class="tier-description">
                                Significant structural damage. Safety systems affected. Airbag deployment. Extensive reconstruction.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calculate-section">
                    <button type="submit" class="calculate-btn">
                        <span>ðŸ“Š</span>
                        Calculate Diminished Value
                    </button>
                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 16px;">
                        <strong>Contact information is required</strong> to receive your assessment results. 
                        Your assessment will be automatically sent to our team for review.
                    </p>
                </div>
            </form>

            <div id="results" class="results">
                <div class="results-header">
                    <h3>Professional Assessment Complete</h3>
                    <div class="results-subtext">Based on industry-standard methodology and current market data</div>
                </div>
                
                <div class="value-display">
                    <div id="valueRange" class="value-range"></div>
                    <div style="color: #059669; font-weight: 500;">Estimated Diminished Value Range</div>
                </div>
                
                <div class="results-details">
                    <div id="resultDetails"></div>
                    
                    <div class="methodology">
                        <strong>Methodology:</strong> This assessment utilizes industry-standard diminished value calculations, 
                        incorporating vehicle depreciation models, market value analysis, and damage severity adjustments 
                        recognized by insurance carriers and legal professionals.
                    </div>
                </div>
            </div>

            <div class="disclaimer">
                <strong>Professional Disclaimer:</strong> This assessment provides an estimated range based on industry-standard 
                methodologies and current market data. Actual diminished value may vary based on regional market conditions, 
                specific vehicle history, documentation quality, and other factors. 
                <br><br>
                <strong>For insurance claims, legal proceedings, or maximum claim value, we strongly recommend upgrading to 
                MyFairClaim's comprehensive professional evaluation service.</strong> Our full assessment includes detailed 
                documentation, expert analysis, comparable vehicle research, and professional support specifically designed 
                for insurance negotiations and legal proceedings. 
                <br><br>
                <strong>MyFairClaim Pro delivers the thorough documentation and expert backing needed to maximize your 
                diminished value recovery.</strong> Contact us to learn more about our professional evaluation services.
            </div>
        </div>
    </div>

    <!-- EmailJS SDK - Updated to latest version -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // EmailJS Configuration - Fully Configured!
        const EMAILJS_PUBLIC_KEY = "mT4t9Rh2jJgV_zObg";  // Your EmailJS Public Key
        const EMAILJS_SERVICE_ID = "service_ny4k9pl";     // Your EmailJS Service ID
        const EMAILJS_TEMPLATE_ID = "template_rs0lmye";   // Your EmailJS Template ID
        
        // Google Sheets Integration Configuration
        const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyD24YqUg6AyiLVdjxYWhXoVrxsUuH8mSeSgrw2-FilqeHBT8kxne_IUbjDG2LudLhtYQ/exec";
        
        // Initialize EmailJS when page is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (typeof emailjs !== 'undefined') {
                    emailjs.init(EMAILJS_PUBLIC_KEY);
                    // Email system ready
                } else {
                    // EmailJS not available
                }
            }, 1000);
        });

        // Handle tier selection
        document.querySelectorAll('.tier').forEach(tier => {
            tier.addEventListener('click', function() {
                document.querySelectorAll('.tier').forEach(t => t.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // Handle form submission
        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get contact information
            const customerName = document.getElementById('customerName').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            
            // Get form values
            const year = parseInt(document.getElementById('year').value);
            const make = document.getElementById('make').value.trim();
            const model = document.getElementById('model').value.trim();
            const mileage = parseInt(document.getElementById('mileage').value);
            const severityElement = document.querySelector('input[name="severity"]:checked');
            
            // Validate all inputs including contact info
            if (!customerName || !customerEmail || !customerPhone || !year || !make || !model || !mileage || !severityElement) {
                alert('Please fill in all required fields and select a damage tier.');
                return;
            }
            
            const severity = parseInt(severityElement.value);
            
            // Calculate vehicle value (simplified but working approach)
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            let baseValue = 25000; // Default value
            
            // Adjust for make
            const makeLower = make.toLowerCase();
            if (['bmw', 'mercedes', 'audi', 'lexus', 'porsche', 'tesla'].includes(makeLower)) {
                baseValue = 45000;
            } else if (['toyota', 'honda', 'ford', 'chevrolet', 'nissan'].includes(makeLower)) {
                baseValue = 28000;
            } else if (['hyundai', 'kia', 'mitsubishi'].includes(makeLower)) {
                baseValue = 22000;
            }
            
            // Apply depreciation
            let currentValue = baseValue;
            for (let i = 0; i < age; i++) {
                currentValue *= 0.88; // 12% depreciation per year
            }
            currentValue = Math.max(currentValue, 3000);
            
            // Adjust for mileage
            const expectedMileage = age * 12000;
            if (mileage > expectedMileage) {
                const excessMileage = mileage - expectedMileage;
                const mileagePenalty = Math.min(0.25, excessMileage * 0.00001);
                currentValue *= (1 - mileagePenalty);
            }
            
            // Get damage percentages
            let minPercent = 0.10;
            let maxPercent = 0.20;
            let tierName = 'Moderate';
            
            if (severity === 1) {
                minPercent = 0.05;
                maxPercent = 0.15;
                tierName = 'Minor';
            } else if (severity === 2) {
                minPercent = 0.15;
                maxPercent = 0.25;
                tierName = 'Moderate';
            } else if (severity === 3) {
                minPercent = 0.25;
                maxPercent = 0.40;
                tierName = 'Major';
            } else if (severity === 4) {
                minPercent = 0.40;
                maxPercent = 0.65;
                tierName = 'Severe';
            }
            
            // Calculate diminished values
            const minValue = Math.round(currentValue * minPercent);
            const maxValue = Math.round(currentValue * maxPercent);
            
            // Create result object
            const result = {
                minValue: minValue,
                maxValue: maxValue,
                currentValue: Math.round(currentValue),
                minPercent: minPercent,
                maxPercent: maxPercent,
                tierName: tierName,
                severity: severity,
                vehicleAge: age,
                year: year,
                make: make,
                model: model,
                mileage: mileage, // Fix: Added missing mileage property
                // Add customer info to result object
                customerName: customerName,
                customerEmail: customerEmail,
                customerPhone: customerPhone
            };
            
            // Display results
            displayResults(result);
            
            // Send email with results (don't let email errors break the calculation display)
            try {
                sendAssessmentEmail(result);
            } catch (emailError) {
                console.log('Email sending failed, but calculation completed successfully:', emailError);
                // Show a simple notification that calculation worked but email needs setup
                setTimeout(() => {
                    showEmailConfirmation(false, 'Calculation completed successfully');
                }, 1000);
            }
        });

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            const valueRangeDiv = document.getElementById('valueRange');
            const detailsDiv = document.getElementById('resultDetails');
            
            // Format currency
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            };
            
            // Format percentage
            const formatPercent = (decimal) => {
                return (decimal * 100).toFixed(1) + '%';
            };
            
            // Display the range
            valueRangeDiv.textContent = `${formatCurrency(result.minValue)} - ${formatCurrency(result.maxValue)}`;
            
            // Display details
            detailsDiv.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Vehicle</span>
                    <span class="result-value">${result.year} ${result.make} ${result.model}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Estimated Market Value</span>
                    <span class="result-value">${formatCurrency(result.currentValue)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Damage Classification</span>
                    <span class="result-value">Tier ${result.severity} - ${result.tierName}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Diminished Value %</span>
                    <span class="result-value">${formatPercent(result.minPercent)} - ${formatPercent(result.maxPercent)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Vehicle Age</span>
                    <span class="result-value">${result.vehicleAge} years</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Assessment Date</span>
                    <span class="result-value">${new Date().toLocaleDateString()}</span>
                </div>
            `;
            
            // Show results
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Mailchimp Integration Configuration
        const MAILCHIMP_API_KEY = "YOUR_MAILCHIMP_API_KEY_HERE"; // Replace with your Mailchimp API key
        const MAILCHIMP_AUDIENCE_ID = "YOUR_AUDIENCE_ID_HERE"; // Replace with your audience ID
        const MAILCHIMP_SERVER_PREFIX = "us1"; // Replace with your server prefix (check your Mailchimp URL)
        
        async function saveToGoogleSheets(result) {
            try {
                // Get user's IP address for tracking
                let userIP = 'Unknown';
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipResponse.json();
                    userIP = ipData.ip;
                } catch (ipError) {
                    console.log('Could not get IP address:', ipError);
                }
                
                // Prepare data for Google Sheets
                const sheetData = {
                    customerName: result.customerName,
                    customerEmail: result.customerEmail,
                    customerPhone: result.customerPhone,
                    year: result.year,
                    make: result.make,
                    model: result.model,
                    mileage: result.mileage,
                    severity: result.severity,
                    tierName: result.tierName,
                    currentValue: result.currentValue,
                    minValue: result.minValue,
                    maxValue: result.maxValue,
                    userIP: userIP
                };
                
                // Send to Google Apps Script
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sheetData)
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    if (responseData.success) {
                        console.log('âœ… Data saved to Google Sheets successfully');
                        // Show user confirmation
                        setTimeout(() => {
                            const confirmDiv = document.createElement('div');
                            confirmDiv.style.cssText = `
                                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                                background: #10b981; color: white; padding: 12px 24px;
                                border-radius: 8px; font-weight: 500; z-index: 1000;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            `;
                            confirmDiv.textContent = 'âœ… Assessment data saved to your system!';
                            document.body.appendChild(confirmDiv);
                            setTimeout(() => confirmDiv.remove(), 4000);
                        }, 500);
                        return true;
                    } else {
                        console.log('âŒ Google Sheets save failed:', responseData.error);
                        return false;
                    }
                } else {
                    console.log('âŒ Network error saving to Google Sheets:', response.status);
                    return false;
                }
            } catch (error) {
                console.log('âŒ Error saving to Google Sheets:', error);
                return false;
            }
        }
        
        async function addToMailchimp(result) {
            try {
                // Determine priority tag based on assessment value
                let priorityTag = "Standard";
                let damageTag = `Damage-Tier-${result.severity}`;
                let vehicleTag = `${result.make}-${result.year}`;
                
                if (result.maxValue > 5000) {
                    priorityTag = "High-Priority";
                } else if (result.maxValue > 2000) {
                    priorityTag = "Medium-Priority";
                } else {
                    priorityTag = "Low-Priority";
                }
                
                // Luxury brand detection
                const luxuryBrands = ['bmw', 'mercedes', 'audi', 'lexus', 'porsche', 'tesla', 'bentley', 'maserati'];
                const isLuxury = luxuryBrands.includes(result.make.toLowerCase());
                
                const subscriberData = {
                    email_address: result.customerEmail,
                    status: "subscribed",
                    merge_fields: {
                        FNAME: result.customerName.split(' ')[0] || result.customerName,
                        LNAME: result.customerName.split(' ').slice(1).join(' ') || '',
                        PHONE: result.customerPhone,
                        VEHICLE: `${result.year} ${result.make} ${result.model}`,
                        DAMAGE: `Tier ${result.severity} - ${result.tierName}`,
                        MINVALUE: `${result.minValue.toLocaleString()}`,
                        MAXVALUE: `${result.maxValue.toLocaleString()}`,
                        CURRENTVAL: `${result.currentValue.toLocaleString()}`,
                        MILEAGE: result.mileage.toLocaleString(),
                        ASSESSMENT: new Date().toLocaleDateString()
                    },
                    tags: [
                        "Diminished-Value-Calculator",
                        priorityTag,
                        damageTag,
                        vehicleTag,
                        isLuxury ? "Luxury-Vehicle" : "Standard-Vehicle",
                        `Year-${result.year}`,
                        `Value-Range-${Math.floor(result.maxValue/1000)}k`
                    ]
                };

                // Send to Mailchimp
                const response = await fetch(`https://${MAILCHIMP_SERVER_PREFIX}.api.mailchimp.com/3.0/lists/${MAILCHIMP_AUDIENCE_ID}/members`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `apikey ${MAILCHIMP_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscriberData)
                });

                if (response.ok) {
                    console.log('âœ… Contact added to Mailchimp successfully');
                    
                    // Show Mailchimp confirmation
                    setTimeout(() => {
                        const mailchimpConfirm = document.createElement('div');
                        mailchimpConfirm.style.cssText = `
                            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
                            background: #ffe01b; color: #333; padding: 12px 24px;
                            border-radius: 8px; font-weight: 500; z-index: 1001;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        `;
                        mailchimpConfirm.textContent = 'ðŸ“§ Added to email campaigns - You\'ll receive follow-up emails with next steps!';
                        document.body.appendChild(mailchimpConfirm);
                        setTimeout(() => mailchimpConfirm.remove(), 5000);
                    }, 1000);
                    
                    return true;
                } else {
                    const errorData = await response.json();
                    console.log('âŒ Mailchimp API error:', errorData);
                    return false;
                }
            } catch (error) {
                console.log('âŒ Error adding to Mailchimp:', error);
                return false;
            }
        }

        function sendAssessmentEmail(result) {
            // First, save to Google Sheets
            saveToGoogleSheets(result).then(sheetSuccess => {
                if (sheetSuccess) {
                    console.log('Data logged to Google Sheets successfully');
                }
            });
            
            // Add to Mailchimp for email automation
            addToMailchimp(result).then(mailchimpSuccess => {
                if (mailchimpSuccess) {
                    console.log('Contact added to Mailchimp successfully');
                }
            });
            
            // Continue with existing email logic...
            if (typeof emailjs === 'undefined') {
                showEmailConfirmation(false, 'EmailJS library not available');
                return;
            }
            
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            };

            const formatPercentage = (decimal) => {
                return (decimal * 100).toFixed(1) + '%';
            };

            const emailParams = {
                to_email: 'support@myfairclaim.com',
                customer_name: result.customerName,
                customer_email: result.customerEmail,
                customer_phone: result.customerPhone,
                
                // Vehicle Information
                vehicle_info: `${result.year} ${result.make} ${result.model}`,
                mileage: result.mileage.toLocaleString() + ' miles',
                vehicle_age: result.vehicleAge + ' years',
                estimated_value: formatCurrency(result.currentValue),
                
                // Assessment Results
                damage_tier: `Tier ${result.severity} - ${result.tierName}`,
                diminished_value_range: `${formatCurrency(result.minValue)} - ${formatCurrency(result.maxValue)}`,
                percentage_range: `${formatPercentage(result.minPercent)} - ${formatPercentage(result.maxPercent)}`,
                
                // Metadata
                assessment_date: new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };

            try {
                // Send email using EmailJS with explicit public key
                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailParams, EMAILJS_PUBLIC_KEY)
                    .then(function(response) {
                        showEmailConfirmation(true);
                    })
                    .catch(function(error) {
                        showEmailConfirmation(false, 'Email sending failed');
                    });
            } catch (error) {
                showEmailConfirmation(false, 'EmailJS error occurred');
            }
        }

        function showEmailConfirmation(success, errorMessage = '') {
            const confirmationDiv = document.createElement('div');
            confirmationDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 350px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                font-size: 14px;
                line-height: 1.4;
            `;
            
            if (success) {
                confirmationDiv.style.background = '#059669';
                confirmationDiv.innerHTML = `
                    <strong>âœ“ Assessment Submitted Successfully!</strong><br>
                    Your assessment has been sent to our team at support@myfairclaim.com. 
                    We'll contact you within 24 hours to discuss your diminished value claim.
                `;
            } else {
                confirmationDiv.style.background = '#059669'; // Still show green for successful calculation
                confirmationDiv.innerHTML = `
                    <strong>âœ“ Assessment Complete!</strong><br>
                    Your diminished value has been calculated successfully. 
                    Please contact us directly at support@myfairclaim.com to discuss your results.
                    <br><small>Note: Email notifications are being configured.</small>
                `;
            }
            
            document.body.appendChild(confirmationDiv);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (confirmationDiv.parentNode) {
                    confirmationDiv.remove();
                }
            }, 8000);
        }

        // Set current year as default
        document.getElementById('year').value = new Date().getFullYear();
        
        // Phone number formatting
        document.getElementById('customerPhone').addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, '');
            if (value.length >= 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
            } else if (value.length >= 3) {
                value = value.replace(/(\d{3})(\d{0,3})/, '($1) $2');
            }
            this.value = value;
        });
        
        // Professional input formatting
        document.getElementById('make').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^a-zA-Z\s-]/g, '');
        });

        document.getElementById('model').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^a-zA-Z0-9\s-]/g, '');
        });
    </script>
</body>
</html>